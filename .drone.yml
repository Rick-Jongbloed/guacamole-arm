kind: pipeline
name: guacamole-client-server-arm

platform:
  os: linux
  arch: arm

steps:
- name: clone-google-guacamole-client
  image: drone/git
  commands: 
  - git clone -b 'staging/1.1.0' --single-branch https://github.com/apache/guacamole-client

- name: build-guacamole-client
  image: arm32v7/maven:3-jdk-8
  commands:
  - mkdir -p client-dist/bin
  - guacamole-client/guacamole-docker/bin/build-guacamole.sh guacamole-client/ $(pwd)/client-dist/
  - cp guacamole-client/guacamole-docker/bin/start.sh client-dist/bin/start.sh
  - cp guacamole-client/guacamole-docker/bin/initdb.sh client-dist/bin/initdb.sh

- name: publish-guacamole-client
  image: docker-registry:5000/drone-plugins/kaniko:latest
  settings:
    registry: docker.artificialcreature.com
    repo: apache/guacamole-client
    tags: 1.1.0-staging
    log: debug
    dockerfile: Dockerfile-client

- name: clone-google-guacamole-server
  image: drone/git
  commands:
  - git clone -b 'staging/1.1.0' --single-branch https://github.com/apache/guacamole-server

- name: build-guacamole-server
  image: ubuntu:18.10
  commands:
  - apt update
  - apt install -y autoconf automake gcc make libossp-uuid-dev libpango1.0-dev libpulse-dev libssh2-1-dev libssl-dev libtelnet-dev libtool libvncserver-dev libwebsockets-dev libwebp-dev libfreerdp-dev libcairo2-dev libjpeg-turbo8-dev libavcodec-dev libavutil-dev libswscale-dev libpng-dev
  - mkdir server-dist
  - guacamole-server/src/guacd-docker/bin/build-guacd.sh guacamole-server/ $(pwd)/server-dist/
  - guacamole-server/src/guacd-docker/bin/list-dependencies.sh $(pwd)/server-dist/sbin/guacd server-dist/lib/libguac-client-*.so $(pwd)/server-dist/lib/freerdp/guac*.so > $(pwd)/server-dist/DEPENDENCIES

- name: publish-guacamole-server
  image: docker-registry:5000/drone-plugins/kaniko:latest
  settings:
    registry: docker.artificialcreature.com
    repo: apache/guacamole-server
    tags: 1.1.0-staging
    log: info
    dockerfile: Dockerfile-server